# I add each file as a dependency of 'all' after I define it as a target.
all:

# Assume all .tex files in this subdirectory are generated by this Makefile
clean:
	rm -f *.tex

# This config may need changing on each machine
ROOT := $(HOME)/code
DB := $(ROOT)/craw-redhat-oss/sqlite/crawl.sqlite
SQLITE3 := sqlite3 -tabs $(DB)

###############################################################
# LaTeX files imported into the main document using \inputgen{}
###############################################################
num-pairs-of-binaries.tex:
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'d" $$($(SQLITE3) "SELECT count(*) FROM gav_interesting_chosen_paths g1 JOIN gav_interesting_chosen_paths g2 USING (runId, groupId, artifactId, version) WHERE g1.provider < g2.provider AND g1.provider NOT LIKE 'maven.repository.redhat.com/ga%' AND g2.provider NOT LIKE 'maven.repository.redhat.com/ga%' AND 'repo1.maven.org/maven2' IN (g1.provider, g2.provider);") > $@

all: num-pairs-of-binaries.tex

num-jar-pairs-after-jnorm2.tex:
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'d" $$(find ../../find-diff-classes/comparisons -name classes.unfiltered|wc -l) > $@

all: num-jar-pairs-after-jnorm2.tex

num-jar-pairs-after-invokevirtual-invokeinterface.tex:
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'d" $$(find ../../find-diff-classes/comparisons -name classes.filtered|wc -l) > $@

all: num-jar-pairs-after-invokevirtual-invokeinterface.tex

num-jar-pairs-after-invokevirtual-invokeinterface-gaoss.tex:
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'d" $$(find ../../find-diff-classes/comparisons -name classes.filtered|perl -lpe 's|^.*/([^/]+\.vs\.[^/]+)|$$1|' |grep obfs|wc -l) > $@

all: num-jar-pairs-after-invokevirtual-invokeinterface-gaoss.tex

num-jar-pairs-after-invokevirtual-invokeinterface-obfs.tex:
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'d" $$(find ../../find-diff-classes/comparisons -name classes.filtered|perl -lpe 's|^.*/([^/]+\.vs\.[^/]+)|$$1|' |grep gaoss|wc -l) > $@

all: num-jar-pairs-after-invokevirtual-invokeinterface-obfs.tex

num-class-pairs-after-invokevirtual-invokeinterface.tex:
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'d" $$(find ../../find-diff-classes/comparisons -name classes.filtered|xargs cat|wc -l) > $@

all: num-class-pairs-after-invokevirtual-invokeinterface.tex

num-top-level-class-pairs-after-invokevirtual-invokeinterface.tex:
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'d" $$(cat ../../find-diff-classes/filtered_top_level_classes.tsv | wc -l) > $@

all: num-top-level-class-pairs-after-invokevirtual-invokeinterface.tex

num-classes-with-generated-tests.tex:
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'d" $$(find ../../find-diff-classes/testgen -name '*_ESTest.java' | wc -l) > $@

all: num-classes-with-generated-tests.tex

num-generated-tests.tex:
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'d" $$(grep '@Test' `find ../../find-diff-classes/testgen -name '*_ESTest.java'` | wc -l) > $@

all: num-generated-tests.tex

avg-tests-per-class.tex: num-generated-tests.tex num-top-level-class-pairs-after-invokevirtual-invokeinterface.tex
	LC_NUMERIC=en_US.utf8 /usr/bin/printf "%'.1f" $$(perl -le 'printf "%.1f", $$ARGV[0] / $$ARGV[1]' `tr -d , < num-generated-tests.tex` `tr -d , < num-top-level-class-pairs-after-invokevirtual-invokeinterface.tex`) > $@

all: avg-tests-per-class.tex

data-summary-table-body.tex:
	$(SQLITE3) "select provider1, provider2, replace(groupId, '/', '.') || ':' || artifactId || ':' || version as artifact, testClass as 'test class', count(*) as 'tests' from differing_failed_test_methods group by 1, 2, 3, 4 order by 1, 2, 3, 4;" | perl -lpe 's/\t/ & /g; $$_ .= " \\\\"; s/_/\\_/g' > $@

all: data-summary-table-body.tex
